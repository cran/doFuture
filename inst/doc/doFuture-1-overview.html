<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<title>doFuture: An Overview on using Foreach to Parallelize via the Future Framework</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.6.0/build/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@11.6.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js" async></script>



<style type="text/css">
body, td {
  font-family: sans-serif;
  background-color: white;
  font-size: 13px;
}
body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 1.5;
  box-sizing: border-box;
}
*, *:before, *:after {
  box-sizing: inherit;
}
tt, code, pre {
  font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}
a:visited { color: #80007f; }
pre, img { max-width: 100%; }
code {
  font-size: 92%;
  border: 1px solid #ccc;
}
code[class] { background-color: #F8F8F8; }
code.language-undefined { background-color: inherit; }
table {
  margin: auto;
  border-top: 1px solid #666;
  border-bottom: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }
thead, tfoot, tr:nth-child(even) { background: #eee; }
blockquote {
  color:#666;
  margin:0;
  padding-left: 1em;
  border-left: 0.5em #eee solid;
}
hr { border: 1px #ddd dashed; }
.frontmatter { text-align: center; }

@media print {
  * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
  }
  body {
    font-size: 12pt;
    max-width: 100%;
  }
  a, a:visited { text-decoration: underline; }
  hr {
    visibility: hidden;
    page-break-before: always;
  }
  pre, blockquote {
    padding-right: 1em;
    page-break-inside: avoid;
  }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page :left { margin: 15mm 20mm 15mm 10mm; }
  @page :right { margin: 15mm 10mm 15mm 20mm; }
  p, h2, h3 { orphans: 3; widows: 3; }
  h2, h3 { page-break-after: avoid; }
}
</style>

<meta name="keywords" content="R, package, vignette, foreach, future, promise, lazy evaluation, synchronous, asynchronous, parallel, cluster">
<meta name="author" content="Henrik Bengtsson">
</head>

<body>
<div class="include-before">

</div>

<div class="frontmatter">
<div class="title"><h1>doFuture: An Overview on using Foreach to Parallelize via the Future Framework</h1></div>
<div class="author"><h2></h2></div>
<div class="date"><h3></h3></div>
</div>

<div class="body">
<h1>doFuture: An Overview on using Foreach to Parallelize via the Future Framework</h1>
<p>The <strong><a href="https://doFuture.futureverse.org">doFuture</a></strong> package provides mechanisms for using the
<strong>foreach</strong> package together with the <strong>future</strong> package such that
<code>foreach()</code> and <code>times()</code> parallelizes via <em>any</em> future backend.</p>
<h2>Introduction</h2>
<p>The <strong><a href="https://future.futureverse.org">future</a></strong> package provides a generic API for using futures in
R.  A future is a simple yet powerful mechanism to evaluate an R
expression and retrieve its value at some point in time.  Futures can
be resolved in many different ways depending on which strategy is
used.  There are various types of synchronous and asynchronous futures
to choose from in the <strong><a href="https://future.futureverse.org">future</a></strong> package.  Additional future
backends are implemented in other packages.  For instance, the
<strong><a href="https://future.batchtools.futureverse.org">future.batchtools</a></strong> package provides futures for <em>any</em> type of
backend that the <strong><a href="https://cran.r-project.org/package=batchtools">batchtools</a></strong> package supports.  For an
introduction to futures in R, please consult the vignettes of the
<strong><a href="https://future.futureverse.org">future</a></strong> package.</p>
<p>The <strong><a href="https://cran.r-project.org/package=foreach">foreach</a></strong> package implements a map-reduce API with functions
<code>foreach()</code> and <code>times()</code> that provides us with powerful methods for
iterating over one or more sets of elements with the option to do it
in parallel.</p>
<h2>Two alternatives</h2>
<p>The <strong><a href="https://doFuture.futureverse.org">doFuture</a></strong> package provides two alternatives for using futures
with <strong>foreach</strong>:</p>
<ol>
<li>
<p><code>registerDoFuture()</code> + <code>y &lt;- foreach(...) %dopar% { ... }</code>.</p>
</li>
<li>
<p><code>y &lt;- foreach(...) %dofuture% { ... }</code></p>
</li>
</ol>
<h3>Alternative 1: <code>registerDoFuture()</code> + <code>%dopar%</code></h3>
<p>The <em>first alternative</em> is based on the traditional <strong>foreach</strong>
approach where one registers a foreach adapter to be used by <code>%dopar%</code>.
A popular adapter is <code>doParallel::registerDoParallel()</code>, which
parallelizes on the local machine using the <strong>parallel</strong> package.
This package provides <code>registerDoFuture()</code>, which parallelizes using
the <strong>future</strong> package, meaning any future-compliant parallel backend
can be used.</p>
<p>An example is:</p>
<pre><code class="language-r">library(doFuture)
registerDoFuture()
plan(multisession)

y &lt;- foreach(x = 1:4, y = 1:10) %dopar% {
  z &lt;- x + y
  slow_sqrt(z)
}
</code></pre>
<p>This alternative is useful if you already have a lot of R code that
uses <code>%dopar%</code> and you just want to switch to using the future
framework for parallelization.  Using <code>registerDoFuture()</code> is also
useful when you wish to use the future framework with packages and
functions that uses <code>foreach()</code> and <code>%dopar%</code> internally,
e.g. <strong><a href="https://cran.r-project.org/package=caret">caret</a></strong>, <strong><a href="https://cran.r-project.org/package=plyr">plyr</a></strong>, <strong><a href="https://cran.r-project.org/package=NMF">NMF</a></strong>, and <strong><a href="https://cran.r-project.org/package=glmnet">glmnet</a></strong>.  It can
also be used to configure the Bioconductor <strong><a href="https://bioconductor.org/packages/BiocParallel/">BiocParallel</a></strong> package,
and any package that rely on it, to parallelize via the future
framework.</p>
<p>See <code>help(&quot;registerDoFuture&quot;, package = &quot;doFuture&quot;)</code> for more details
and examples on this approach.</p>
<h3>Alternative 2: <code>%dofuture%</code></h3>
<p>The <em>second alternative</em>, which uses <code>%dofuture%</code>, avoids having to use
<code>registerDoFuture()</code>.  The <code>%dofuture%</code> operator provides a more
consistent behavior than <code>%dopar%</code>, e.g. there is a unique set of
foreach arguments instead of one per possible adapter.  Identification
of globals, random number generation (RNG), and error handling is
handled by the future ecosystem, just like with other map-reduce
solutions such as <strong><a href="https://future.apply.futureverse.org">future.apply</a></strong> and <strong><a href="https://furrr.futureverse.org">furrr</a></strong>.
An example is:</p>
<pre><code class="language-r">library(doFuture)
plan(multisession)

y &lt;- foreach(x = 1:4, y = 1:10) %dofuture% {
  z &lt;- x + y
  slow_sqrt(z)
}
</code></pre>
<p>This alternative is the recommended way to let <code>foreach()</code> parallelize
via the future framework if you start out from scratch.</p>
<p>See <code>help(&quot;%dofuture%&quot;, package = &quot;doFuture&quot;)</code> for more details and
examples on this approach.</p>

</div>

<div class="include-after">

</div>

<script src="https://cdn.jsdelivr.net/combine/npm/@xiee/utils/js/center-img.min.js" async></script>
<script>

</script>
</body>

</html>
